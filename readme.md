# Cerber
### Сервис для регистрации на мероприятия


## Локальный запуск
В проекте используется реляционная база данных PostgreSQL, которая разворачивается
прямо на запускаемом хосте. Соответственно, для локального запуска у вас
должен быть установлен постгрес. Строка подключения к бд задаётся
в файле `/cerber/Web/appsettings.json` по пути `$.ConnectionStrings.DbConnection`

В этом же файле задаются секреты для почтового клиента, с которого будут
отправлять билеты пользователям, по пути `$.EmailCredentials`. Без заполнения этих данных
приложение будет работать, кроме функциональности для отправки писем

Далее необходимо скомпилировать фронтенд, перевенсти react typescript + scss в js и css.
Для этого необходимо установить все npm пакеты, находясь в папке `/cerber/WebFront`
выполните команду
```shell
npm install
```

После загрузки пакетов надо запустить вебпак для компиляции и сборки всех зависимостей.
для этого в этой же папке пропишите
```shell
npm run startDev
```
или
```shell
npm run startProd
```
После успешной компиляции вебпак можно остановить

Для запуска самого сервиса необходимо собрать и запустить консольное приложения dotnet,
для этого находясь в папке /cerber/Web выполните команду
```shell
dotnet run
```

Сервис запустится и начнёт работать по адресу https://localhost:7061 для защищённого
соединения и http://localhost:5226 для незащищённого по протоколу http


## RabbitMQ
Сервис использует сервер RabbitMq для генерации билетов пользователей по шаблону
и их отправки на почту.

Оф документация по уствноке на винду: https://www.rabbitmq.com/docs/install-windows.
Крутой видос в помощь: https://www.youtube.com/watch?v=KhYiaEOrw7Q.

P.S.: необходимо установить erlang, rabbitmq server, запустить плагины,
все подробности в видео.

Сервер запустится по адресу http://localhost:5672/.

Мониторинг сервера запустится по адресу http://localhost:15672/,
пароль и логин по умолчанию - guest:guest. 

### Если не хочется раскатывать брокер сообщений локально
В ServiceCollectionExtensions.AddExternals надо закомментировать
строчку с одним AddScoped<BaseRabbitMqProducer<TicketDestinationMessage>>
и раскомментировать с другим AddScoped<BaseRabbitMqProducer<TicketDestinationMessage>>


## Продьюсинг сообщений
После успешной оплаты билета OrderService отправляет сообщение
в брокер с помощью TicketRabbitMqProducer с необходимой
информацией для последующей генерации и отправки билета пользователю.
Если в процессе обработки сообщения что-то упало с ошибкой, сообщение
возвращается в очередь и будет бесконечно пытаться снова обработать сообщение.
Нужно доработать - после нескольких попыток отправлять сообщение в отдельную
очередь или exchange.


## Отправка сообщений
Демон RabbitMqListener разбирает сообщения из брокера

### Генерация картинки
При получении сообщения из очереди с отправкой билета
консьюмер генерирует картинку билета в соответствии с шаблоном
/cerber/RabbitMqListener/StaticFiles/TicketTemplate.cshtml.

Для начала RazorEngine компилирует файл в соответствии с моделькой,
на выходе получаем html. Затем с помощью библиотеки DinkToPdf, которая
является провайдером для утилиты wkhtmltopdf, генерирует из html
файл pdf, который позже отправим пользователю на почту

#### Особенности DinkToPdf
Для работы DinkToPdf в проект добавлены 3 dll библиотеки - libwkhtmltox
(уже лежат в репе), также для ubuntu необходимо установить архивный пакет - libssl1.0.
Также на линукс надо установить саму утилиту wkhtmltopdf, которая
и генерирует pdf. 

Также DinkToPdf почему-то ломается, если в css стилях указывать width/height: 100%
или указывать max-width/max-height. Ещё не работает transform: translate(...), поэтому
для перемещения qr кода используется margin. Ещё почему-то надо подбирать странный
PechkinPaperSize PaperSize.

Ещё необходимо указывать полный путь до css и в html при генерации и в RazorEngine,
и в ObjectSettings.WebSettings.UserStyleSheet (для DinkToPdf)


Затем полученный pdf файл отправляется на почту, которая была указана в сообщении брокера.


## Доп инфа
Не забывайте указывать креды в appsettings.json в RabbitMqListener и в самом сервисе Web.


